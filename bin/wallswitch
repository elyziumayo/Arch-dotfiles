#!/bin/bash
#    ██╗    ██╗ █████╗ ██╗     ██╗     ███████╗██╗    ██╗██╗████████╗ ██████╗██╗  ██╗
#    ██║    ██║██╔══██╗██║     ██║     ██║     ██║    ██║██║╚══██╔══╝██╔════╝██║  ██║
#    ██║ █╗ ██║███████║██║     ██║     ███████╗██║ █╗ ██║██║   ██║   ██║     ███████║
#    ██║███╗██║██╔══██║██║     ██║     ╚════██║██║███╗██║██║   ██║   ██║     ██╔══██║
#    ╚███╔███╔╝██║  ██║███████╗███████╗███████║╚███╔███╔╝██║   ██║   ╚██████╗██║  ██║
#     ╚══╝╚══╝ ╚═╝  ╚═╝╚══════╝╚══════╝╚══════╝ ╚══╝╚══╝ ╚═╝   ╚═╝    ╚═════╝╚═╝  ╚═╝
WALLPAPER_DIR="$HOME/wallpapers"

[[ ! -d "$WALLPAPER_DIR" ]] && exit 1

cd "$WALLPAPER_DIR" || exit 1

selected=$(find . -type f \( -name "*.jpg" -o -name "*.png" \) | sed 's|./||' | while read -r img; do
    printf "${img%.*}\0icon\x1f$WALLPAPER_DIR/$img\n"
done | rofi -dmenu -show-icons -i -matching fuzzy \
    -kb-cancel 'Escape' \
    -theme-str 'window {location: center; anchor: center; width: 1300px; height: 373px; border-radius: 10px 0px 0px 0px;}' \
    -theme-str 'mainbox {padding: 0px; spacing: 0px; children: ["listview", "inputbar"];}' \
    -theme-str 'inputbar {padding: 5px; children: ["entry"];background-image:none;border:2px 0px 0px 0px solid;}' \
    -theme-str 'listview {columns: 4; lines: 1;}' \
    -theme-str 'element {orientation: vertical; children: [element-text, element-icon]; border-radius: 5px 5px 0px 0px;}' \
    -theme-str 'element-icon {size: 283px;}' \
    -theme-str 'element-text {font: "JetBrains Mono Propo 10"; horizontal-align: 0.1; margin: 20px 0px 0px 0px;}')

[[ -z "$selected" ]] && exit 0

wallpaper=$(find . -type f \( -name "${selected}.jpg" -o -name "${selected}.png" \) | sed 's|./||' | head -n 1)

if [[ -n "$wallpaper" ]]; then
    matugen image "$WALLPAPER_DIR/$wallpaper"
    ffmpeg -i "$WALLPAPER_DIR/$wallpaper" -vf "crop=728:151" "$HOME/.config/rofi/theme/default.png" -y 2>/dev/null
fi
